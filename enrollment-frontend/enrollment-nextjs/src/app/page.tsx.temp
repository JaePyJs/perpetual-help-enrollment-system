"use client";
import React, { useState, useEffect } from "react";
import Image from "next/image";
import Link from "next/link";
import { supabase } from "@/lib/supabaseClient";
import { ThemeSwitcher } from "./ThemeSwitcher";
import styles from "./page.module.css";

const roleTabs = [
  { id: "student", label: "Student", icon: "üéì" },
  { id: "teacher", label: "Teacher", icon: "üë©‚Äçüè´" },
  { id: "admin", label: "Admin", icon: "‚öôÔ∏è" },
] as const;

type Role = (typeof roleTabs)[number]["id"];

type Fields = {
  student: { email: string; password: string };
  teacher: { email: string; password: string };
  admin: { email: string; password: string };
};

type ShowPassword = {
  student: boolean;
  teacher: boolean;
  admin: boolean;
};

export default function LoginPage() {
  const [activeTab, setActiveTab] = useState<Role>("student");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const [showPassword, setShowPassword] = useState<ShowPassword>({
    student: false,
    teacher: false,
    admin: false,
  });
  const [fields, setFields] = useState<Fields>({
    student: { email: "", password: "" },
    teacher: { email: "", password: "" },
    admin: { email: "", password: "" },
  });

  // Keyboard navigation for tabs
  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      if (e.key === "Tab" && e.altKey) {
        e.preventDefault();
        const idx = roleTabs.findIndex((t) => t.id === activeTab);
        setActiveTab(roleTabs[(idx + 1) % roleTabs.length].id);
      }
    };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, [activeTab]);

  // Handle input changes
  const handleInput = (
    role: Role,
    field: "email" | "password",
    value: string
  ) => {
    setFields((f) => ({ ...f, [role]: { ...f[role], [field]: value } }));
  };

  // Handle login
  const handleLogin = async (e: React.FormEvent, role: Role) => {
    e.preventDefault();
    setError("");
    setLoading(true);
    const { email, password } = fields[role];
    if (!email || !password) {
      setError("Please enter both username and password");
      setLoading(false);
      return;
    }
    
    try {
      // Supabase Auth logic (customize per role if needed)
      const { error: loginError } = await supabase.auth.signInWithPassword({
        email,
        password,
      });
      
      if (loginError) {
        setError(loginError.message);
        setLoading(false);
        return;
      }
      
      // Redirect logic (customize per role)
      if (role === "student") window.location.href = "/student-dashboard";
      else if (role === "teacher") window.location.href = "/teacher-dashboard";
      else if (role === "admin") window.location.href = "/admin-dashboard";
    } catch (err) {
      setError("An unexpected error occurred. Please try again.");
      setLoading(false);
      console.error("Login error:", err);
    }
  };

  // Image switching logic
  const getActiveImage = () => {
    if (activeTab === "student") return "/images/students.png";
    if (activeTab === "teacher") return "/images/teacher.png";
    return "/images/admin.png";
  };

  return (
    <>
      <ThemeSwitcher />
      <div className="wrapper">
        <div className="container">
          <div className="left-panel">
            <div className="image-text-wrapper">
              <div className="image-container student-theme">
                <Image
                  src={getActiveImage()}
                  alt={`${
                    activeTab.charAt(0).toUpperCase() + activeTab.slice(1)
                  } Portal`}
                  width={180}
                  height={180}
                  className="role-image active"
                  priority
                />
              </div>
              <div className="welcome-message">
                <h2>
                  <b>Welcome to Perpetual!</b>
                </h2>
              </div>
            </div>
          </div>
          <div className="right-panel">
            {error && (
              <div id="error-message" className="error-message">
                {error}
              </div>
            )}
            <div className="nav-tabs" role="tablist">
              {roleTabs.map((tab) => (
                <button
                  key={tab.id}
                  className={`tab-link${activeTab === tab.id ? " active" : ""}`}
                  onClick={() => {
                    setActiveTab(tab.id);
                    setError("");
                  }}
                  role="tab"
                  aria-controls={tab.id}
                  aria-selected={activeTab === tab.id ? "true" : "false"}
                  tabIndex={0}
                  type="button"
                >
                  <span aria-hidden="true">{tab.icon}</span>
                  {tab.label}
                  <span className="sr-only">Login</span>
                </button>
              ))}
            </div>
            {roleTabs.map((tab) => (
              <form
                key={tab.id}
                id={tab.id}
                className={`tab-content${
                  activeTab === tab.id ? " active" : ""
                }`}
                onSubmit={(e) => handleLogin(e, tab.id)}
              >
                <h3 className={`${tab.id}-login-heading`}>
                  {tab.icon} {tab.label} Log in
                </h3>
                <input
                  type="text"
                  placeholder={
                    tab.id === "student" ? "User" : tab.label + " ID"
                  }
                  value={fields[tab.id].email}
                  onChange={(e) => handleInput(tab.id, "email", e.target.value)}
                  required
                  autoComplete="username"
                  aria-label={tab.label + " username"}
                />
                <input
                  type={showPassword[tab.id] ? "text" : "password"}
                  placeholder="Password"
                  className="password-input"
                  value={fields[tab.id].password}
                  onChange={(e) =>
                    handleInput(tab.id, "password", e.target.value)
                  }
                  required
                  autoComplete="current-password"
                  aria-label={tab.label + " password"}
                />
                <div className="actions">
                  <Link
                    className="forgot"
                    href="/forgot-password"
                    prefetch={false}
                  >
                    Forgot Username or Password?
                  </Link>
                  <button
                    type="button"
                    className={`show-password${
                      showPassword[tab.id] ? " active" : ""
                    }`}
                    onClick={() =>
                      setShowPassword((s) => ({ ...s, [tab.id]: !s[tab.id] }))
                    }
                    aria-pressed={showPassword[tab.id] ? "true" : "false"}
                  >
                    {showPassword[tab.id] ? "Hide" : "Show"}
                  </button>
                </div>
                <button
                  type="submit"
                  className={`continue${loading ? " loading" : ""}`}
                  disabled={loading}
                >
                  {loading ? "Logging in..." : "Continue"}
                </button>
              </form>
            ))}
          </div>
        </div>
      </div>
    </>
  );
}
