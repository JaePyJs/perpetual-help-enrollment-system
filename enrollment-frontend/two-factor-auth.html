<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Factor Authentication | School Enrollment System</title>
    <link rel="stylesheet" href="css/security-styles.css">
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #fdf6f2;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo img {
            max-width: 200px;
        }
        
        .title {
            color: #41413c;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="two-factor-container">
        <div class="logo">
            <img src="images/logo.png" alt="School Logo" onerror="this.src='data:image/svg+xml;charset=utf-8,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 viewBox%3D%220 0 100 100%22%3E%3Ctext y%3D%22.9em%22 font-size%3D%2290%22%3EðŸ«%3C%2Ftext%3E%3C%2Fsvg%3E';this.onerror=null;">
        </div>
        
        <h1 class="two-factor-title">Two-Factor Authentication</h1>
        <p class="two-factor-subtitle">A verification code has been sent to your email address. Please enter it below to continue.</p>
        
        <form id="two-factor-form" action="javascript:void(0);" onsubmit="verifyCode()">
            <div class="verification-code-input">
                <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required autofocus>
                <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
            </div>
            
            <button type="submit" class="access-denied-button" style="width: 100%;">Verify</button>
            
            <div class="resend-code">
                <button type="button" id="resend-button" class="resend-code-button" disabled>Resend code</button>
                <span class="verification-timer" id="timer">Resend available in 30 seconds</span>
            </div>
        </form>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setupCodeInputs();
            startResendTimer();
            
            // Retrieve user info from session storage (this would be set during login)
            const userEmail = sessionStorage.getItem('userEmail') || 'your email';
            
            // Update the subtitle with the user's email (partially masked)
            const emailParts = userEmail.split('@');
            if (emailParts.length === 2) {
                const username = emailParts[0];
                const maskedUsername = username.substring(0, 3) + '***' + username.substring(username.length - 2);
                const domain = emailParts[1];
                
                document.querySelector('.two-factor-subtitle').textContent = 
                    `A verification code has been sent to ${maskedUsername}@${domain}. Please enter it below to continue.`;
            }
        });
        
        // Set up code input fields to automatically move focus to next input
        function setupCodeInputs() {
            const inputs = document.querySelectorAll('.verification-code-input input');
            
            inputs.forEach((input, index) => {
                // Move to next input when a digit is entered
                input.addEventListener('input', function() {
                    if (this.value.length === this.maxLength) {
                        if (inputs[index + 1]) {
                            inputs[index + 1].focus();
                        }
                    }
                });
                
                // Handle backspace to go to previous input
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && inputs[index - 1]) {
                        inputs[index - 1].focus();
                    }
                });
                
                // Handle paste event
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text');
                    
                    // If pasted data is a 6-digit code, distribute across inputs
                    if (/^\d{6}$/.test(pastedData)) {
                        inputs.forEach((input, i) => {
                            input.value = pastedData.charAt(i);
                        });
                        
                        // Focus the last input
                        inputs[inputs.length - 1].focus();
                    }
                });
            });
        }
        
        // Start the timer for resending the code
        function startResendTimer() {
            const timerDisplay = document.getElementById('timer');
            const resendButton = document.getElementById('resend-button');
            let secondsLeft = 30;
            
            const interval = setInterval(() => {
                secondsLeft--;
                
                if (secondsLeft <= 0) {
                    clearInterval(interval);
                    timerDisplay.style.display = 'none';
                    resendButton.disabled = false;
                } else {
                    timerDisplay.textContent = `Resend available in ${secondsLeft} seconds`;
                }
            }, 1000);
            
            // Set up resend button
            resendButton.addEventListener('click', function() {
                // Log the resend request
                logSecurityEvent('resend_verification_code');
                
                // Disable the button
                this.disabled = true;
                timerDisplay.style.display = 'block';
                
                // Simulate sending a new code
                alert('A new verification code has been sent to your email address.');
                
                // Restart the timer
                secondsLeft = 30;
                timerDisplay.textContent = `Resend available in ${secondsLeft} seconds`;
                
                const interval = setInterval(() => {
                    secondsLeft--;
                    
                    if (secondsLeft <= 0) {
                        clearInterval(interval);
                        timerDisplay.style.display = 'none';
                        resendButton.disabled = false;
                    } else {
                        timerDisplay.textContent = `Resend available in ${secondsLeft} seconds`;
                    }
                }, 1000);
            });
        }
        
        // Verify the entered code
        function verifyCode() {
            const inputs = document.querySelectorAll('.verification-code-input input');
            let code = '';
            
            // Combine the inputs to form the code
            inputs.forEach(input => {
                code += input.value;
            });
            
            // In a real application, this would validate against a server
            // For demo purposes, we'll accept any 6-digit code
            if (code.length === 6 && /^\d{6}$/.test(code)) {
                // Log the successful verification
                logSecurityEvent('verification_success');
                
                // Redirect to the appropriate dashboard based on role
                const userRole = sessionStorage.getItem('userRole') || 'student';
                
                switch (userRole) {
                    case 'admin':
                        window.location.href = 'admin-dashboard.html';
                        break;
                    case 'teacher':
                        window.location.href = 'teacher-dashboard.html';
                        break;
                    default:
                        window.location.href = 'student-enrollment.html';
                }
            } else {
                // Log the failed verification
                logSecurityEvent('verification_failed');
                
                // Show error message
                alert('Invalid verification code. Please try again.');
                
                // Clear the inputs
                inputs.forEach(input => {
                    input.value = '';
                });
                
                // Focus the first input
                inputs[0].focus();
            }
        }
        
        // Log security events
        function logSecurityEvent(event, details = {}) {
            // Get user ID if available
            const userId = sessionStorage.getItem('userId') || 'unknown';
            
            // Create the log entry
            const logEntry = {
                userId: userId,
                event: event,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                details: details
            };
            
            console.log('Security Event:', logEntry);
            
            // Store locally (in a real app, this would be sent to the server)
            const securityLogs = JSON.parse(localStorage.getItem('securityLogs') || '[]');
            securityLogs.push(logEntry);
            
            // Keep only the most recent logs
            if (securityLogs.length > 100) {
                securityLogs.shift();
            }
            
            localStorage.setItem('securityLogs', JSON.stringify(securityLogs));
        }
    </script>
</body>
</html>
